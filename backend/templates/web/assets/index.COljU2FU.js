import{r as N}from"./index.WrgjqPzT.js";import{i as z,L as j}from"./echarts.D5sl-F-p.js";import{d as q,g as G,h as C,j as H,I as K,v as R,K as J,k as b,y as Q,a as X,o as U,l as a,w as l,e as u,s as V,q as D,A as Z,b as tt}from"./vue.UJNVWY_g.js";import{_ as et}from"./_plugin-vue_export-helper.DlAUqK2U.js";const at={class:"home-container"},st={class:"stat-card"},lt={class:"stat-value"},ot={class:"stat-card"},nt={class:"stat-value"},rt={class:"stat-card"},it={class:"stat-value"},dt={class:"stat-card"},ut={class:"stat-value"},mt={class:"chart-title"},ct={class:"chart-title"},ft=q({name:"home"}),pt=q({...ft,setup(vt){const c=G({totalCustomers:0,totalDevices:0,needPayCount:0,todayIncome:0,todayDevices:0,paidCount:0,totalIncome:0,totalCost:0}),M=C(!1),k=C([]),F=C(null),I=C(null);let g=null,_=null,w=null;const $=C(!1),L=1e4,y=C("month");let A=[];const S=C("month"),x=o=>o.reduce((t,e)=>t+(isFinite(e)?e:0),0),h=o=>{const t=Number(o);return isFinite(t)?t:0},O=o=>Number(o||0).toFixed(2),Y=o=>{const t=String(o??"");return t.replace(/\u3000+/g," ").trim()||t},P=()=>{const o=[],t=new Date;for(let e=11;e>=0;e--){const m=new Date(t.getFullYear(),t.getMonth()-e,1);o.push(`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}`)}return o},B=o=>{if(!g&&F.value&&(g=z(F.value)),!g)return;const t=new Date;let e=[];if(y.value==="day"){const r=t.getFullYear(),s=t.getMonth(),d=new Date(r,s+1,0).getDate();e=Array.from({length:d},(f,i)=>String(i+1).padStart(2,"0"))}else if(y.value==="month")e=P();else{const r=t.getFullYear();e=Array.from({length:5},(s,d)=>String(r-(4-d)))}const m=e.map(r=>x(o.filter(s=>{const d=String(s.date||"");if(y.value==="day"){const f=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;return d.startsWith(f)&&d.slice(8,10)===r}return y.value==="month"?d.slice(0,7)===r:d.slice(0,4)===r}).map(s=>h(s.amount)))),p=e.map(r=>x(o.filter(s=>{const d=String(s.date||"");if(y.value==="day"){const f=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;return d.startsWith(f)&&d.slice(8,10)===r}return y.value==="month"?d.slice(0,7)===r:d.slice(0,4)===r}).map(s=>h(s.device)))),n={tooltip:{trigger:"axis"},legend:{data:["收款金额","设备数量"]},grid:{top:"16%",right:"5%",bottom:"12%",left:"10%"},xAxis:{type:"category",data:e},yAxis:{type:"value"},series:[{name:"收款金额",type:"bar",data:m,barWidth:"40%",itemStyle:{color:"#67C23A"}},{name:"设备数量",type:"bar",data:p,barWidth:"40%",itemStyle:{color:new j(0,0,0,1,[{offset:0,color:"#83bff6"},{offset:1,color:"#188df0"}])}}]};g.setOption(n)},W=o=>{if(!_&&I.value&&(_=z(I.value)),!_)return;const t=new Date;let e=[];if(S.value==="day"){const n=t.getFullYear(),r=t.getMonth(),s=new Date(n,r+1,0).getDate();e=Array.from({length:s},(d,f)=>String(f+1).padStart(2,"0"))}else if(S.value==="month")e=P();else{const n=t.getFullYear();e=Array.from({length:5},(r,s)=>String(n-(4-s)))}const m=e.map(n=>{const r=new Set;return o.forEach(s=>{const d=String(s.date||"");if(S.value==="day"){const f=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;d.startsWith(f)&&d.slice(8,10)===n&&r.add(Y(s.name))}else S.value==="month"?d.slice(0,7)===n&&r.add(Y(s.name)):d.slice(0,4)===n&&r.add(Y(s.name))}),r.size}),p={tooltip:{trigger:"axis"},grid:{top:"16%",right:"5%",bottom:"12%",left:"10%"},xAxis:{type:"category",data:e},yAxis:{type:"value"},series:[{name:"合并客户数",type:"line",smooth:!0,areaStyle:{},data:m,itemStyle:{color:"#409EFF"}}]};_.setOption(p)},T=()=>{g&&g.resize(),_&&_.resize()},E=async()=>{if(!$.value){$.value=!0,(!g||!_)&&(M.value=!0);try{const o=new Date,t=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,[e,m,p]=await Promise.all([N({url:"/api/system/customer/",method:"get",params:{limit:9999}}),N({url:"/api/system/customer/",method:"get",params:{start_date:t,end_date:t,limit:9999}}),N({url:"/api/system/finance/",method:"get",params:{}})]),n=(e==null?void 0:e.data)||[];A=n;const r=(m==null?void 0:m.data)||[],s=(p==null?void 0:p.data)||[],d=i=>{const v=String(i??"");return v.replace(/\u3000+/g," ").trim()||v},f=new Set(n.map(i=>d(i.name))).size;c.totalCustomers=f,c.totalDevices=x(n.map(i=>h(i.device))),c.needPayCount=n.filter(i=>!!i.is_need_pay).length,c.paidCount=n.filter(i=>!!i.is_paid).length,c.totalIncome=x(s.map(i=>h(i.income))),c.totalCost=x(s.map(i=>h(i.amount))),c.todayDevices=x(r.map(i=>h(i.device))),c.todayIncome=x(r.map(i=>h(i.amount))),k.value=n.filter(i=>!!i.is_need_pay).sort((i,v)=>h(v.amount)-h(i.amount)).slice(0,8),B(n),W(n)}finally{M.value=!1,$.value=!1}}};return H(async()=>{await K(),F.value&&(g=z(F.value)),I.value&&(_=z(I.value)),await E(),window.addEventListener("resize",T),w=setInterval(E,L);const o=()=>{document.hidden?w&&(clearInterval(w),w=null):w||(w=setInterval(E,L))};document.addEventListener("visibilitychange",o),window.__home_onVis=o}),R(y,()=>{B(A)}),R(S,()=>{W(A)}),J(()=>{window.removeEventListener("resize",T),g&&g.dispose(),_&&_.dispose(),w&&clearInterval(w);const o=window.__home_onVis;o&&document.removeEventListener("visibilitychange",o)}),(o,t)=>{const e=b("el-card"),m=b("el-col"),p=b("el-row"),n=b("el-radio-button"),r=b("el-radio-group"),s=b("el-table-column"),d=b("el-tag"),f=b("el-table"),i=Q("loading");return U(),X("div",at,[a(p,{gutter:12,class:"mb-2"},{default:l(()=>[a(m,{xs:24,sm:12,md:12,lg:6,xl:6},{default:l(()=>[a(e,{shadow:"hover"},{default:l(()=>[u("div",st,[t[2]||(t[2]=u("div",{class:"stat-title"},"客户总数",-1)),u("div",lt,V(c.totalCustomers),1)])]),_:1})]),_:1}),a(m,{xs:24,sm:12,md:12,lg:6,xl:6},{default:l(()=>[a(e,{shadow:"hover"},{default:l(()=>[u("div",ot,[t[3]||(t[3]=u("div",{class:"stat-title"},"设备总数",-1)),u("div",nt,V(c.totalDevices),1)])]),_:1})]),_:1}),a(m,{xs:24,sm:12,md:12,lg:6,xl:6},{default:l(()=>[a(e,{shadow:"hover"},{default:l(()=>[u("div",rt,[t[4]||(t[4]=u("div",{class:"stat-title"},"今日装机数量",-1)),u("div",it,V(c.todayDevices),1)])]),_:1})]),_:1}),a(m,{xs:24,sm:12,md:12,lg:6,xl:6},{default:l(()=>[a(e,{shadow:"hover"},{default:l(()=>[u("div",dt,[t[5]||(t[5]=u("div",{class:"stat-title"},"今日收款金额",-1)),u("div",ut,V(O(c.todayIncome)),1)])]),_:1})]),_:1})]),_:1}),a(p,{gutter:12,class:"mb-2"},{default:l(()=>[a(m,{xs:24,sm:24,md:14,lg:14,xl:14},{default:l(()=>[a(e,{"body-style":{height:"360px",padding:"8px"},shadow:"hover"},{default:l(()=>[u("div",mt,[t[9]||(t[9]=u("span",null,"收款金额与客户数量",-1)),a(r,{modelValue:y.value,"onUpdate:modelValue":t[0]||(t[0]=v=>y.value=v),size:"small",class:"chart-toggle"},{default:l(()=>[a(n,{label:"year"},{default:l(()=>[...t[6]||(t[6]=[D("年",-1)])]),_:1}),a(n,{label:"month"},{default:l(()=>[...t[7]||(t[7]=[D("月",-1)])]),_:1}),a(n,{label:"day"},{default:l(()=>[...t[8]||(t[8]=[D("日",-1)])]),_:1})]),_:1},8,["modelValue"])]),u("div",{ref_key:"barRef",ref:F,class:"chart"},null,512)]),_:1})]),_:1}),a(m,{xs:24,sm:24,md:10,lg:10,xl:10},{default:l(()=>[a(e,{"body-style":{height:"360px",padding:"8px"},shadow:"hover"},{default:l(()=>[u("div",ct,[t[13]||(t[13]=u("span",null,"合并客户数量",-1)),a(r,{modelValue:S.value,"onUpdate:modelValue":t[1]||(t[1]=v=>S.value=v),size:"small",class:"chart-toggle"},{default:l(()=>[a(n,{label:"year"},{default:l(()=>[...t[10]||(t[10]=[D("年",-1)])]),_:1}),a(n,{label:"month"},{default:l(()=>[...t[11]||(t[11]=[D("月",-1)])]),_:1}),a(n,{label:"day"},{default:l(()=>[...t[12]||(t[12]=[D("日",-1)])]),_:1})]),_:1},8,["modelValue"])]),u("div",{ref_key:"lineRef",ref:I,class:"chart"},null,512)]),_:1})]),_:1})]),_:1}),a(p,{gutter:12},{default:l(()=>[a(m,{xs:24,sm:24,md:24,lg:24,xl:24},{default:l(()=>[a(e,{shadow:"hover"},{default:l(()=>[t[14]||(t[14]=u("div",{class:"table-title"},"待缴费客户",-1)),Z((U(),tt(f,{data:k.value,size:"small",style:{width:"100%"}},{default:l(()=>[a(s,{prop:"name",label:"客户","min-width":"140"}),a(s,{prop:"device",label:"设备数",width:"90"}),a(s,{prop:"amount",label:"金额",width:"110"}),a(s,{prop:"uploader",label:"上传人",width:"120"}),a(s,{prop:"is_need_pay",label:"需缴费",width:"100"},{default:l(v=>[a(d,{type:v.row.is_need_pay?"danger":"success"},{default:l(()=>[D(V(v.row.is_need_pay?"是":"否"),1)]),_:2},1032,["type"])]),_:1}),a(s,{prop:"date",label:"日期","min-width":"120"})]),_:1},8,["data"])),[[i,M.value]])]),_:1})]),_:1})]),_:1})])}}}),bt=et(pt,[["__scopeId","data-v-1a6ed83e"]]);export{bt as default};
