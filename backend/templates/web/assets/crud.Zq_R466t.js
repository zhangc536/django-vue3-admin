import{r as y,o as M,q as u,F,b as g,X as b}from"./index.WrgjqPzT.js";import{h as A,I as q}from"./vue.UJNVWY_g.js";const w="/api/system/customer/";function R(a){return y({url:w+a+"/mark_paid/",method:"post"})}function Y(a){return y({url:w+a+"/mark_unpaid/",method:"post"})}function T(a){return y({url:w+"bulk_delete/",method:"post",data:{ids:a}})}function N(a){return y({url:w+"bulk_mark_paid/",method:"post",data:{ids:a}})}function W(a){return y({url:w+"bulk_mark_unpaid/",method:"post",data:{ids:a}})}function B(a){const n={...a},l=n.form||{},c=m=>m===!0||m==="true"||m==="True"?"True":m===!1||m==="false"||m==="False"?"False":m;return typeof l.is_need_pay<"u"&&(l.is_need_pay=c(l.is_need_pay)),typeof n.is_need_pay<"u"&&(n.is_need_pay=c(n.is_need_pay)),typeof l.is_paid<"u"&&(l.is_paid=c(l.is_paid)),typeof n.is_paid<"u"&&(n.is_paid=c(n.is_paid)),!n.start_date&&Array.isArray(n.date)&&n.date.length===2?(n.start_date=n.date[0],n.end_date=n.date[1],delete n.date):!n.start_date&&typeof n.date=="string"&&n.date&&(n.start_date=n.date,n.end_date=n.date,delete n.date),!n.start_date&&Array.isArray(l.date)&&l.date.length===2?(n.start_date=l.date[0],n.end_date=l.date[1],delete l.date):!n.start_date&&typeof l.date=="string"&&l.date&&(n.start_date=l.date,n.end_date=l.date,delete l.date),l.start_date&&(n.start_date||(n.start_date=l.start_date),delete l.start_date),l.end_date&&(n.end_date||(n.end_date=l.end_date),delete l.end_date),n.form=l,y({url:w,method:"get",params:n})}function C(a){return y({url:w,method:"post",data:a})}function P(a){return y({url:w+a.id+"/",method:"put",data:a})}function j(a){return y({url:w+a+"/",method:"delete",data:{id:a}})}const $=function({crudExpose:a}){const n=async t=>{var o;const e=t||{},r=((o=a==null?void 0:a.getSearchFormData)==null?void 0:o.call(a))??{},i=r.form??r??{},d={...e.form||{},...i||{}};return e.time_quick&&(e.date=D(e.time_quick),delete e.time_quick),d.time_quick&&(e.date=D(d.time_quick),delete d.time_quick),!e.start_date&&Array.isArray(e.date)&&e.date.length===2?(e.start_date=e.date[0],e.end_date=e.date[1],delete e.date):!e.start_date&&typeof e.date=="string"&&e.date?(e.start_date=e.date,e.end_date=e.date,delete e.date):!e.start_date&&Array.isArray(d.date)&&d.date.length===2?(e.start_date=d.date[0],e.end_date=d.date[1],delete d.date):!e.start_date&&typeof d.date=="string"&&d.date&&(e.start_date=d.date,e.end_date=d.date,delete d.date),e.start_date&&(d.start_date=e.start_date),e.end_date&&(d.end_date=e.end_date),e.form=d,await B(e)},l=async({form:t})=>(t.date||(t.date=new Date().toLocaleDateString("en-CA")),await C(t)),c=async({form:t,row:e})=>(t.id=e.id,await P(t)),m=async({row:t})=>await j(t.id),f=t=>t.toLocaleDateString("en-CA"),D=t=>{const e=new Date;if(t==="day"){const r=new Date(e.getFullYear(),e.getMonth(),e.getDate());return f(r)}if(t==="month"){const r=new Date(e.getFullYear(),e.getMonth(),1),i=new Date(e.getFullYear(),e.getMonth()+1,0);return[f(r),f(i)]}if(t==="year"){const r=new Date(e.getFullYear(),0,1),i=new Date(e.getFullYear(),11,31);return[f(r),f(i)]}return[]},S=t=>{if(!t||isNaN(t.getTime()))return 0;const e=new Date,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),i=new Date(e.getFullYear(),e.getMonth(),e.getDate());if(i.getTime()<r.getTime())return 0;let d=(i.getFullYear()-r.getFullYear())*12+(i.getMonth()-r.getMonth());return new Date(r.getFullYear(),r.getMonth()+d,r.getDate()).getTime()>i.getTime()&&(d+=1),d<=0&&(d=1),d},v=t=>t===!0||t==="true"||t==="True"||t===1||t==="1"?!0:t===!1||t==="false"||t==="False"||t===0||t==="0"?!1:!!t,s=A(document.body.clientWidth<768);return M.on("layoutMobileResize",t=>{s.value=t.clientWidth<768}),{crudOptions:{request:{pageRequest:n,addRequest:l,editRequest:c,delRequest:m},table:{rowKey:"id",onSelectionChange(t){const r=a.getTableData().filter(i=>!t.includes(i));b.arrayEach(t,i=>{b.pluck(p.value,"id").includes(i.id)||(p.value=b.union(p.value,[i]))}),b.arrayEach(r,i=>{p.value=b.remove(p.value,d=>d.id!==i.id)})},onRefreshed:()=>O()},actionbar:{buttons:{batchPaid:{text:"批量标记缴费",type:"primary",click:async()=>{const e=(p.value??[]).map(r=>r.id);if(!e.length){g.error("请先选择数据");return}await N(e),g.success("批量标记缴费成功"),a.doRefresh()}},batchUnpaid:{text:"批量标记未缴费",click:async()=>{const e=(p.value??[]).map(r=>r.id);if(!e.length){g.error("请先选择数据");return}await W(e),g.success("批量标记未缴费成功"),a.doRefresh()}},batchDelete:{text:"批量删除",type:"danger",click:async()=>{const e=(p.value??[]).map(r=>r.id);if(!e.length){g.error("请先选择数据");return}await T(e),g.success("批量删除成功"),a.doRefresh()}}}},rowHandle:{fixed:"right",width:u(()=>s.value?140:220),buttons:{view:{show:!1},edit:{type:"text"},remove:{type:"text"},togglePaid:{text:"缴费/取消",order:11,click:async({row:t})=>{try{const e=v(t.is_need_pay);v(t.is_paid)||!e?(await Y(t.id),g.success("已取消缴费")):(await R(t.id),g.success("已确认缴费")),a.doRefresh()}catch(e){g.error("操作失败"),console.error(e)}},show:u(({row:t})=>v(t.is_need_pay)&&!v(t.is_paid))}}},columns:{_index:{title:"序号",form:{show:!1},column:{align:"center",width:"70px",show:u(()=>!s.value),columnSetDisabled:!0,formatter:t=>{let e=t.index??1,r=a.crudBinding.value.pagination;return((r.currentPage??1)-1)*r.pageSize+e+1}}},$checked:{title:"选择",form:{show:!1},column:{type:"selection",align:"center",width:u(()=>s.value?"40px":"60px"),columnSetDisabled:!0}},time_quick:{title:"时间筛选",type:"dict-select",column:{show:!1},form:{show:!1},dict:F({data:[{label:"今天",value:"day"},{label:"本月",value:"month"},{label:"今年",value:"year"}]}),search:{show:!0,component:{props:{clearable:!0}},valueResolve(t){const{value:e}=t;if(!e){delete t.form.date,delete t.form.time_quick,delete t.form.start_date,delete t.form.end_date;return}const r=D(e);t.form.date=r,Array.isArray(r)&&r.length===2?(t.form.start_date=r[0],t.form.end_date=r[1]):typeof r=="string"&&r&&(t.form.start_date=r,t.form.end_date=r),t.form.time_quick=e},valueChange:{async handle({value:t,form:e}){var _,h;const r=e??((h=(_=a==null?void 0:a.getSearchFormData)==null?void 0:_.call(a))==null?void 0:h.form)??{};if(!t){const k={...r};delete k.date,delete k.time_quick,delete k.start_date,delete k.end_date,a.setSearchFormData({form:k}),a.doSearch({});return}const i=D(t),o={...{...r},time_quick:t,date:i};Array.isArray(i)&&i.length===2?(o.start_date=i[0],o.end_date=i[1]):typeof i=="string"&&i&&(o.start_date=i,o.end_date=i),a.setSearchFormData({form:o}),a.doSearch({})}}}},name:{title:"客户名称",type:"input",search:{show:!0,component:{props:{clearable:!0,placeholder:"请输入客户名称"}}},column:{minWidth:u(()=>s.value?140:150)}},amount:{title:"收款金额",type:"number",form:{component:{props:{min:0,step:.01}}},column:{minWidth:u(()=>s.value?120:140)}},reminder_datetime:{form:{show:!1},column:{show:!1}},net_fee:{title:"网费/电费",type:"text",form:{show:!1},column:{show:u(()=>!s.value),minWidth:160,formatter({row:t}){const e=t.date?new Date(t.date):null;if(!e||isNaN(e.getTime()))return"0";const r=S(e),i=Math.max(0,Number(t.device||0));return String(70*r*i)}}},electric_fee:{title:"电费",type:"number",form:{show:!1},column:{show:!1}},depreciation_fee:{title:"设备折旧费",type:"text",form:{show:!1},column:{show:u(()=>!s.value),minWidth:140,formatter({row:t}){const e=Math.max(0,Number(t.device||0));return String(500*e)}}},device:{title:"设备",type:"number",form:{component:{props:{min:0}}},column:{minWidth:140,show:u(()=>!s.value)}},date:{title:"日期",type:"date",search:{show:!0,component:{type:"daterange",props:{valueFormat:"YYYY-MM-DD"}},valueResolve(t){const{value:e}=t;e&&Array.isArray(e)&&e.length===2&&(t.form.date=e,delete t.form.date_start,delete t.form.date_end,delete t.form.time_quick,t.form.start_date=e[0],t.form.end_date=e[1])},valueChange(t,e,r){var o,_;const i=r??((_=(o=a==null?void 0:a.getSearchFormData)==null?void 0:o.call(a))==null?void 0:_.form)??{};if(!e||!Array.isArray(e)||e.length!==2){const h={...i};delete h.date,delete h.start_date,delete h.end_date,a.setSearchFormData({form:h}),a.doSearch({});return}const d={...i};delete d.time_quick,a.setSearchFormData({form:{...d,date:e,start_date:e[0],end_date:e[1]}}),a.doSearch({})}},form:{component:{props:{valueFormat:"YYYY-MM-DD"}},value:new Date().toLocaleDateString("en-CA")},column:{minWidth:u(()=>s.value?120:140)}},reminder_months:{title:"下次缴费时间",type:"number",form:{component:{props:{min:1,step:1,placeholder:"请输入月数"}}},column:{show:u(()=>!s.value),minWidth:160,formatter({row:t}){const e=t.reminder_datetime?new Date(t.reminder_datetime):null,r=e&&!isNaN(e.getTime())?e:(()=>{const _=Number(t.reminder_months||0),h=t.date?new Date(t.date):new Date;return!_||isNaN(_)?null:new Date(h.getTime()+_*30*24*60*60*1e3)})();if(!r||isNaN(r.getTime()))return"";const i=r.getFullYear(),d=String(r.getMonth()+1).padStart(2,"0"),o=String(r.getDate()).padStart(2,"0");return`${i}-${d}-${o}`}}},is_need_pay:{title:"是否需要缴费",type:"dict-select",dict:F({data:[{label:"需缴费",value:!0},{label:"不需缴费",value:!1}]}),form:{show:!1},column:{minWidth:u(()=>s.value?90:100)},search:{show:!0,component:{type:"dict-select",props:{clearable:!0,placeholder:"请选择"}},valueResolve(t){t.form.is_need_pay=t.value}}},uploader:{title:"上传者",type:"input",form:{disabled:!0},column:{minWidth:160,show:u(()=>!s.value)}},remark:{title:"备注",type:"dict-select",dict:F({data:[{label:"梯子费",value:"梯子费"},{label:"管理费",value:"管理费"},{label:"安装费",value:"安装费"}]}),form:{component:{props:{clearable:!0,multiple:!0,collapseTags:!0,placeholder:"请选择备注类型"}}},column:{show:u(()=>!s.value),minWidth:220,formatter({row:t}){const e=t.remark;return Array.isArray(e)?e.join("、"):typeof e=="string"?e.split(",").filter(Boolean).join("、"):""}},valueBuilder(t){const e=t.value;return Array.isArray(e)?e:typeof e=="string"?e.split(",").filter(Boolean):[]},valueResolve(t){const e=t.form.remark;Array.isArray(e)&&(t.form.remark=e.join(","))}}}}}},p=A([]),O=()=>{var c,m;const a=(c=crudExpose.getBaseTableRef)==null?void 0:c.call(crudExpose),n=(m=crudExpose.getTableData)==null?void 0:m.call(crudExpose);if(!a||!n)return;const l=b.filter(n,f=>b.pluck(p.value,"id").includes(f.id));q(()=>{b.arrayEach(l,f=>{a.toggleRowSelection(f,!0)})})};export{$ as createCrudOptions};
